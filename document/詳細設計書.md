# 部活動勤怠管理システム 詳細設計書

## 1. はじめに

### 1.1 設計方針
- Firebase → Supabase移行による高性能・大容量対応
- 班別・学年別データ集計の高速化
- Discord OAuth統合による安全な認証
- キーボード操作優先のUI設計
- 既存kiosk画面との整合性確保
- QRコード読み取り後の自動画面遷移による使いやすさ向上

### 1.2 想定読者
- システム開発者
- 部活動管理者
- システム運用担当者

### 1.3 関連ドキュメント
- 部活動勤怠管理システム企画書
- 部活動勤怠管理システム要件定義書

## 2. データベース設計

### 2.1 テーブル構成図
```
teams (班テーブル)
├── id (PK, int)
├── name (varchar, 班名)
└── created_at

users (ユーザーテーブル)
├── id (PK, uuid)
├── display_name (unique, varchar) -- 表示用ID兼ニックネーム
├── discord_id (varchar) -- Discord連携用（数字のみ）
├── generation (int) -- 期生
├── team_id (FK → teams.id, int) -- 班
├── role (int) -- 0:部員, 1:部長/管理者
├── card_id (varchar, not null, unique) -- カードID（1枚のみ）
├── is_active (boolean) -- アカウント有効性
└── created_at, updated_at

attendances (出退勤記録)
├── id (PK, uuid)
├── user_id (FK → users.id)
├── type (varchar) -- 'in' or 'out'
├── timestamp (timestamptz) -- 打刻時刻
├── date (date) -- 日付（集計用インデックス）
└── created_at

announcements (お知らせ)
├── id (PK, uuid)
├── title (varchar)
├── content (text)
├── author_id (FK → users.id)
├── is_active (boolean) -- 論理削除用（false=削除済み）
├── is_current (boolean) -- 現在表示中フラグ（true=1件のみ）
└── created_at, updated_at

user_edit_logs (ユーザー情報変更履歴)
├── id (PK, uuid)
├── target_user_id (FK → users.id) -- 変更対象ユーザー
├── editor_user_id (FK → users.id) -- 変更実行者
├── field_name (varchar) -- 変更フィールド名
├── old_value (text) -- 変更前の値
├── new_value (text) -- 変更後の値
└── created_at

daily_logout_logs (全員退勤実行ログ)
├── id (PK, uuid)
├── executed_at (timestamptz)
├── affected_count (int) -- 対象ユーザー数
└── status (varchar) -- 'success' or 'error'

temp_registrations (仮登録テーブル)
├── id (PK, uuid)
├── card_id (varchar, unique) -- カードID
├── qr_token (varchar, unique) -- QRコード用トークン
├── expires_at (timestamptz) -- 有効期限（30分）
├── is_used (boolean) -- 使用済みフラグ
├── accessed_at (timestamptz, nullable) -- QR読み取り時刻
└── created_at
```

### 2.2 制約・ルール
- カードIDのユニーク制約：1ユーザー1枚のみ（NOT NULL）
- DiscordIDとカードIDは1:1関係
- お知らせの現在表示フラグ：1件のみ表示可能
- 表示名のユニーク制約：重複不可
- 班テーブルとの外部キー制約
- 仮登録の有効期限：30分
- QR読み取り検知用タイムスタンプ管理

### 2.3 パフォーマンス設計
```sql
-- 出退勤データの高速集計用インデックス
CREATE INDEX idx_attendances_date_user ON attendances (date, user_id);
CREATE INDEX idx_attendances_user_timestamp ON attendances (user_id, timestamp);

-- カード認証用インデックス
CREATE UNIQUE INDEX idx_users_card_id ON users (card_id);
CREATE UNIQUE INDEX idx_users_discord_id ON users (discord_id);

-- 集計用インデックス
CREATE INDEX idx_users_team_generation ON users (team_id, generation);

-- 仮登録管理用インデックス
CREATE INDEX idx_temp_registrations_qr_token ON temp_registrations (qr_token);
CREATE INDEX idx_temp_registrations_expires ON temp_registrations (expires_at);
CREATE INDEX idx_temp_registrations_accessed ON temp_registrations (accessed_at);

-- 日別班別集計用マテリアライズドビュー
CREATE MATERIALIZED VIEW daily_team_stats AS
SELECT 
  a.date,
  u.team_id,
  u.generation,
  COUNT(DISTINCT CASE WHEN a.type = 'in' THEN a.user_id END) as attendance_count
FROM attendances a
JOIN users u ON a.user_id = u.id
GROUP BY a.date, u.team_id, u.generation;
```

## 3. API設計

### 3.1 エンドポイント一覧

#### 認証系API
```
POST /api/auth/discord/callback - Discord OAuth認証後のコールバック処理
GET /api/auth/me - 現在ログイン中ユーザー情報取得
POST /api/auth/logout - ログアウト処理
```

#### 打刻系API
```
POST /api/attendance - カード打刻処理
GET /api/attendance/status/:user_id - 指定ユーザーの現在勤務状況取得
```

#### 管理系API
```
GET /api/admin/force-logout-all - 全員強制退勤処理
GET /api/users - ユーザー一覧取得（権限により制限）
PUT /api/users/:id - ユーザー情報編集（履歴保存付き）
PUT /api/admin/users/:id/card - カードID変更（管理者のみ）
GET /api/stats/daily/:date - 指定日の班別・学年別集計データ
```

#### お知らせ系API
```
GET /api/announcements/current - 現在表示中のお知らせ1件取得
POST /api/announcements - お知らせ作成（管理者のみ）
PUT /api/announcements/:id/activate - 指定お知らせを現在表示に設定
DELETE /api/announcements/:id - お知らせ論理削除
```

#### 登録系API
```
POST /api/registration/temp - 仮登録作成（カードID受付）
GET /api/registration/qr/:token - QRコード用情報取得・アクセス記録
POST /api/registration/complete - 本登録完了（Discord認証後）
GET /api/registration/cleanup - 期限切れ仮登録データ削除
```

### 3.2 認証・登録フロー

#### 新規登録フロー
1. **Kiosk側（ラズパイ）**：「/」キー押下
2. **Kiosk側**：カードをタッチ → temp_registrations に仮登録
3. **Kiosk側**：QRコード生成・表示（30分有効）
4. **スマートフォン側**：QRコード読取 → accessed_at更新 → Kiosk画面自動復帰
5. **スマートフォン側**：Discord OAuth認証画面へリダイレクト
6. **スマートフォン側**：認証成功 → 期生ロール確認
7. **スマートフォン側**：本登録完了 → users テーブルに登録

#### QRコード内容
```
https://your-app.vercel.app/register/{qr_token}
```

### 3.3 エラーハンドリング
- 未登録カード：「未登録のカードです」メッセージ表示
- 通信エラー：「通信エラーが発生しました」メッセージ表示
- 登録期限切れ：「登録期限が切れています」メッセージ表示
- 重複登録：「このカードは既に登録されています」メッセージ表示

## 4. 画面設計

### 4.1 画面構成一覧
- `/` - 打刻画面（ラズパイ専用kiosk画面）
- `/login` - Discord OAuth ログイン画面
- `/dashboard` - 個人ダッシュボード
- `/admin` - 管理者ダッシュボード
- `/register/:token` - 登録画面（QRコードアクセス用・スマートフォン）

### 4.2 打刻画面（kiosk画面）

#### 通常待機状態
```
┌─────────────────────────────────────┐
│ STEM研究部 勤怠管理システム     [オンライン] │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │  🔔  集会について                │ │
│ │     本日部活動集会を行います。      │ │
│ │     集合してください。            │ │
│ └─────────────────────────────────┘ │
│                                     │
│              23:13                  │
│         2025年9月17日 水曜日         │
│                                     │
│              📶                    │
│                                     │
│      NFCタグをタッチしてください      │
│                                     │
│  カードリーダーにタッチするか、IDをキーボード │
│            で入力してください          │
│                                     │
│     新しいカードを登録するには / キー    │
└─────────────────────────────────────┘
```

#### カードID入力中状態
```
┌─────────────────────────────────────┐
│ STEM研究部 勤怠管理システム     [オンライン] │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │  🔔  お知らせ表示エリア            │ │
│ └─────────────────────────────────┘ │
│                                     │
│              23:13                  │
│         2025年9月17日 水曜日         │
│                                     │
│          📶 入力中...               │
│                                     │
│          入力中: ABC1234            │
│                                     │
│      そのまま入力を続けてください      │
└─────────────────────────────────────┘
```

#### 打刻成功状態
```
┌─────────────────────────────────────┐
│ STEM研究部 勤怠管理システム     [オンライン] │
│                                     │
│              23:13                  │
│         2025年9月17日 水曜日         │
│                                     │
│              ✅                     │
│                                     │
│         表示ユーザー名               │
│            出勤しました              │
│                                     │
│           23:13:45                  │
│                                     │
│         (5秒後に自動的に戻ります)      │
└─────────────────────────────────────┘
```

#### 未登録カード状態
```
┌─────────────────────────────────────┐
│ STEM研究部 勤怠管理システム     [オンライン] │
│                                     │
│              23:13                  │
│         2025年9月17日 水曜日         │
│                                     │
│              👤                    │
│                                     │
│        未登録のカードです            │
│                                     │
│    登録するには「/」キーを押してください   │
│                                     │
│         (5秒後に自動的に戻ります)      │
└─────────────────────────────────────┘
```

#### 登録モード状態
```
┌─────────────────────────────────────┐
│ STEM研究部 勤怠管理システム     [オンライン] │
│                                     │
│              📝                     │
│                                     │
│          新規カード登録              │
│                                     │
│      登録したいカードをタッチしてください   │
│                                     │
│        キャンセルするにはEscキー       │
└─────────────────────────────────────┘
```

#### QRコード表示状態
```
┌─────────────────────────────────────┐
│ STEM研究部 勤怠管理システム     [オンライン] │
│                                     │
│            QRコード登録              │
│                                     │
│        ■■■■■■■■■■■■        │
│        ■    ■      ■    ■        │
│        ■  ■■  ■■  ■■  ■        │
│        ■    ■      ■    ■        │
│        ■■■■■■■■■■■■        │
│                                     │
│   スマートフォンでQRコードを読み取り    │
│       Discord認証を完了してください    │
│                                     │
│       有効期限: あと28分34秒          │
│                                     │
│   ※QR読み取り後、自動的に戻ります      │
└─────────────────────────────────────┘
```

### 4.3 登録画面 (`/register/:token`) - スマートフォン用

#### レスポンシブデザイン対応
```
┌─────────────────────────────────────┐
│ 🏠 STEM研究部 勤怠管理システム        │
├─────────────────────────────────────┤
│                                     │
│           📱 カード登録              │
│                                     │
│    QRコードスキャンありがとうございます  │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │ 📇 カード情報                   │ │
│ │ ID: ABC123456789               │ │
│ │ 読み取り: 2025/09/17 23:15     │ │
│ └─────────────────────────────────┘ │
│                                     │
│      このカードを登録しますか？        │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │   🔗 Discordで認証して登録する   │ │
│ └─────────────────────────────────┘ │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │         ❌ キャンセル           │ │
│ └─────────────────────────────────┘ │
│                                     │
│     ⚠️ 登録には期生ロールが必要です     │
│                                     │
│    残り時間: ⏰ 28分34秒             │
└─────────────────────────────────────┘
```

#### 登録完了画面（スマートフォン用）
```
┌─────────────────────────────────────┐
│ 🏠 STEM研究部 勤怠管理システム        │
├─────────────────────────────────────┤
│                                     │
│              ✅                     │
│                                     │
│          登録が完了しました！          │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │ 👤 表示ユーザー名               │ │
│ │ 🏷️ Web班・9期生                │ │
│ │ 📇 カード: ABC***789           │ │
│ └─────────────────────────────────┘ │
│                                     │
│    これでカードが使用可能になりました    │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │      📱 ダッシュボードへ        │ │
│ └─────────────────────────────────┘ │
│                                     │
│      カードリーダーで打刻してください    │
└─────────────────────────────────────┘
```

### 4.4 個人ダッシュボード
サイドバー形式で班別情報と個人勤怠データを表示
- 左サイドバー：班一覧と出席状況
- メインエリア：個人の勤怠統計と履歴
- 出勤率、出勤日数、総労働時間の表示
- 最近の出勤記録をカレンダー形式で表示

### 4.5 管理者ダッシュボード
- ユーザー管理機能：基本情報編集、カード管理、権限変更
- お知らせ管理機能：現在表示お知らせの編集、過去履歴管理
- 集計表示機能：日別班別出席状況、カレンダー形式表示
- 仮登録管理機能：未完了登録の確認・削除

### 4.6 キーボードショートカット
- 打刻画面：Enter（手動確認）、Esc（エラークリア・登録キャンセル）、/（登録モード）
- ダッシュボード：↑/↓（班選択）、Enter（詳細表示）、Tab（フォーカス移動）

## 5. システム構成・デプロイ設計

### 5.1 アーキテクチャ図
```
[NFC Card] → [Raspberry Pi Kiosk] ←─┐
                    ↓               │ (QR Access Detection)
            [QR Code Display]       │ (Auto Return to Normal)
                    ↓               │
[Smartphone] → [QR Code Scan] → [Next.js App (Vercel)]
                    ↓                       ↓
            [Discord OAuth] →       [Supabase API]
                                           ↓
                                   [PostgreSQL DB]
```

### 5.2 技術スタック
- フロントエンド：Next.js 14 + React + TypeScript
- バックエンド：Supabase (PostgreSQL + API + Auth)
- ホスティング：Vercel
- 認証：Discord OAuth + Supabase Auth
- リアルタイム通信：Supabase Realtime
- QRコード生成：qrcode.js

### 5.3 環境変数
- NEXT_PUBLIC_SUPABASE_URL
- NEXT_PUBLIC_SUPABASE_ANON_KEY
- SUPABASE_SERVICE_ROLE_KEY
- DISCORD_CLIENT_ID
- DISCORD_CLIENT_SECRET
- NEXT_PUBLIC_DISCORD_SERVER_ID
- NEXT_PUBLIC_GENERATION_ROLE_PREFIX
- NEXT_PUBLIC_APP_URL

### 5.4 Supabase設定
- Row Level Security (RLS) による権限制御
- リアルタイム機能でお知らせとQRアクセス検知の自動更新
- PostgreSQL関数による複雑な集計処理
- 定期的な仮登録データクリーンアップ

## 6. 運用・監視設計

### 6.1 定期処理
- 毎日23:05：全員退勤API実行（curl）
- 毎週日曜日：マテリアライズドビュー更新
- 毎日6時間おき：Supabaseヘルスチェック
- 毎10分：期限切れ仮登録データクリーンアップ
- リアルタイム：QRアクセス検知によるKiosk画面自動復帰

### 6.2 ログ・監視項目
- 全員退勤API実行ログ（ラズパイ生死確認を兼ねる）
- ユーザー情報変更履歴（管理者操作追跡用）
- API応答時間監視
- データベース使用容量監視
- 仮登録データの滞留監視
- QRアクセスパターン監視

### 6.3 バックアップ・復旧
- Supabase自動バックアップ機能を利用
- 重要データの定期エクスポート
- 障害時の代替手段（手動記録）
- 仮登録データの復旧手順

### 6.4 セキュリティ対策
- Discord サーバーメンバー限定アクセス
- 期生ロールによる認証制御
- 個人情報のSupabase外保存（Discord参照）
- HTTPS通信の強制
- 仮登録データの有効期限管理
- QRコードトークンの暗号化
- QRアクセス後の自動画面復帰によるプライバシー保護

## 7. 移行設計

### 7.1 Firebaseからのデータ移行
- 既存ユーザー情報のエクスポート
- 出退勤履歴データの変換・インポート
- 班・期生情報の再構築
- テストデータによる動作確認
- Discord ID の数字形式への変換

### 7.2 移行スケジュール
- Phase 1：Supabase環境構築・データ移行
- Phase 2：Next.jsアプリケーション開発・QRコード登録機能実装
- Phase 3：Discord OAuth連携・QRアクセス検知機能・テスト運用
- Phase 4：本格稼働・旧システム停止

test