# 部活動勤怠管理システム 要件定義書

## 1. 概要

### 1.1 目的
- Firebaseの読み取り上限問題を解決し、安定した部活動勤怠管理を実現する
- オンプレサーバー不要で無料運用可能なクラウドベースシステムを構築する
- Discord認証と期生ロールを活用した安全なアクセス制御を提供する
- QRコードによる簡単なカード登録機能を実現する

### 1.2 適用範囲
- 対象者：100名以下の部活動メンバー
- 利用端末：ラズベリーパイ1台（打刻・登録用）+ PC・スマートフォン（閲覧・登録完了用）
- 運用環境：学校施設内ネットワーク + インターネット接続

## 2. 機能要件

### 2.1 打刻機能

#### 2.1.1 基本打刻処理
- **機能概要**：NFC/RFIDカードのタッチによる出退勤記録
- **入力**：カードIDのHIDキーボード入力
- **処理**：
  1. カードIDを受信（連続入力+Enter または 0.5秒タイムアウト）
  2. カードIDでユーザー検索
  3. 前回勤務ステータスの逆を適用（初回は全員退勤状態のため出勤扱い）
  4. タイムスタンプ付きでデータベースに記録
- **出力**：WebUI画面での打刻完了表示（5秒間表示後自動復帰）

#### 2.1.2 エラーハンドリング
- **未登録カード**：「未登録のカードです」メッセージを表示
- **通信エラー**：「通信エラーが発生しました」メッセージを表示
- **重複打刻**：短時間連続タッチでも通常処理を実行

#### 2.1.3 自動退勤機能
- **実行方法**：シンプルなGETリクエスト（curl対応）
- **実行URL**：`GET /api/admin/force-logout-all`
- **処理内容**：全員を強制退勤状態に変更
- **ログ出力**：実行履歴をデータベースに保存

### 2.2 カード登録機能

#### 2.2.1 登録開始処理
- **開始方法**：Kiosk画面で「/」キー押下
- **カード読取**：登録したいカードをタッチ
- **仮登録作成**：temp_registrationsテーブルに30分有効期限で保存
- **QRコード表示**：登録用URLを含むQRコードをKiosk画面に表示

#### 2.2.2 QRコード処理
- **QRコード内容**：`https://your-app.vercel.app/register/{qr_token}`
- **アクセス検知**：QRコードが読み取られると自動的にKiosk画面が通常状態に復帰
- **有効期限**：30分（期限切れ後は自動削除）

#### 2.2.3 本登録処理
- **実行端末**：スマートフォン
- **認証フロー**：Discord OAuth認証 → 期生ロール確認
- **登録完了**：usersテーブルへの本登録とtemp_registrationsの無効化
- **完了通知**：登録完了画面をスマートフォンに表示

### 2.3 認証機能

#### 2.3.1 Discord OAuth認証
- **認証方式**：Discord OAuth + Supabase Auth連携
- **アクセス制限**：特定Discordサーバーメンバーのみ
- **ロール確認**：期生ロールの付与確認
- **エラー処理**：非メンバーのアクセス時はエラー画面表示

#### 2.3.2 権限管理
- **一般ユーザー**：自分の勤怠データ閲覧のみ
- **管理者**：全ユーザーデータ閲覧 + ユーザー管理機能 + カード管理機能
- **権限設定**：管理者がユーザー管理画面から設定

### 2.4 勤怠閲覧機能

#### 2.4.1 個人勤怠表示
- **表示内容**：個人の出退勤履歴（カレンダー形式）
- **統計情報**：出勤率、出勤日数、総労働時間
- **操作方式**：キーボード操作を基本とし、マウス使用を最小限に抑制

#### 2.4.2 管理者用集計表示
- **表示内容**：日別の班・学年別人数集計
- **操作方法**：カレンダー日付クリックで該当日データを表示
- **班別フィルタ**：サイドバーでの班選択による絞り込み表示

### 2.5 ユーザー管理機能

#### 2.5.1 ユーザー情報管理（修正）
- **管理項目**：
  - DiscordユーザーID（数字のみ）
  - 表示用ニックネーム（display_name）
  - カードID（1枚のみ、NOT NULL制約）
  - 期生
  - 班（teamsテーブルへの外部キー）
  - 権限レベル（0:部員, 1:管理者）
- **操作機能**：強制出退勤、ユーザー情報編集、カードID変更（管理者のみ）
- **変更履歴**：全ての編集操作を履歴として保存

#### 2.5.2 データ移行機能
- **移行元**：Firebase
- **移行内容**：既存ユーザー情報、勤怠履歴
- **移行先**：Supabase PostgreSQL
- **変換処理**：Discord名の数字形式への変換

### 2.6 お知らせ機能

#### 2.6.1 お知らせ表示
- **表示場所**：Kiosk画面上部
- **表示件数**：1件のみ（is_current=trueフラグで管理）
- **更新方式**：Supabase Realtimeによる自動更新

#### 2.6.2 お知らせ管理
- **作成・編集**：管理者のみ
- **履歴管理**：論理削除による過去データ保持
- **表示切替**：任意のお知らせを現在表示に設定可能

## 3. 非機能要件

### 3.1 性能要件
- **応答時間**：打刻処理3秒以内、画面表示2秒以内
- **同時利用者数**：制限なし（Vercel・Supabase無料プラン範囲内）
- **データ集計**：マテリアライズドビューによる高速集計処理

### 3.2 可用性要件
- **稼働時間**：24時間365日（ラズベリーパイ常時稼働）
- **利用時間**：部活動時間帯（実際の打刻は活動時のみ）
- **一時停止対策**：定期的なSupabaseヘルスチェック実行

### 3.3 セキュリティ要件
- **個人情報保護**：Supabaseには個人情報を保存せず、DiscordユーザーIDのみ保存
- **アクセス制御**：Discord OAuth + 期生ロール確認
- **データ暗号化**：HTTPS通信、Supabase標準暗号化
- **QRセキュリティ**：トークンの暗号化と有効期限管理

### 3.4 運用性要件
- **データ保持**：勤怠データは永続保存
- **ログ管理**：
  - 全員退勤API実行ログ
  - ユーザー情報変更履歴
  - QRコード登録アクセスログ
- **バックアップ**：Supabase自動バックアップ機能を利用
- **データクリーンアップ**：期限切れ仮登録データの自動削除

## 4. 制約条件

### 4.1 技術制約
- **使用技術**：Next.js, Supabase, Vercel, Discord OAuth
- **無料プラン制限**：
  - Supabase：500MB DB容量、50,000 MAU
  - Vercel：100GB転送量、非商用利用
- **カード制限**：1ユーザーあたり1枚のみ

### 4.2 運用制約
- **予算制約**：月額費用0円での運用
- **ネットワーク制約**：オンプレサーバー設置不可
- **登録制約**：QRコード有効期限30分

### 4.3 ハードウェア制約
- **打刻端末**：ラズベリーパイ1台のみ
- **カードリーダー**：HIDキーボード入力対応NFC/RFIDリーダー
- **登録端末**：スマートフォン（QRコード読取・Discord認証用）

## 5. インターフェース要件

### 5.1 外部システム連携
- **Discord API**：OAuth認証、ユーザー情報取得、ロール確認
- **Supabase API**：データベース操作、リアルタイム更新
- **QRコード生成**：qrcode.jsライブラリによる動的生成

### 5.2 ユーザーインターフェース

#### 5.2.1 Kiosk画面（ラズベリーパイ）
- **通常画面**：時刻表示、お知らせ表示、打刻指示
- **入力中画面**：カードID入力状況のリアルタイム表示
- **結果画面**：打刻成功・エラーの5秒間表示
- **登録画面**：QRコード表示とアクセス検知による自動復帰

#### 5.2.2 管理画面
- **個人ダッシュボード**：レスポンシブWebアプリ（PC・スマートフォン対応）
- **管理者ダッシュボード**：ユーザー管理、お知らせ管理、集計表示
- **登録画面**：スマートフォン専用レスポンシブデザイン

#### 5.2.3 操作方式
- **Kiosk画面**：キーボード操作優先設計（/キー：登録開始、Escキー：キャンセル）
- **Web画面**：タッチ・マウス・キーボード操作対応

## 6. 画面遷移要件

### 6.1 Kiosk画面遷移
- **通常待機** → **入力中** → **結果表示** → **通常待機**
- **通常待機** → **登録モード** → **QRコード表示** → **通常待機**（QR読取検知時）

### 6.2 スマートフォン画面遷移
- **QRコード読取** → **登録確認** → **Discord認証** → **登録完了**

### 6.3 自動復帰機能
- **結果表示画面**：5秒後に自動復帰
- **QRコード画面**：読取検知時に即座に復帰
- **エラー画面**：5秒後に自動復帰
