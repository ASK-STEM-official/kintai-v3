# 部活動勤怠管理システム 要件定義書

## 1. 概要

### 1.1 目的
- Firebaseの読み取り上限問題を解決し、安定した部活動勤怠管理を実現する
- オンプレサーバー不要で無料運用可能なクラウドベースシステムを構築する
- Discord認証と期生ロールを活用した安全なアクセス制御を提供する

### 1.2 適用範囲
- 対象者：100名以下の部活動メンバー
- 利用端末：ラズベリーパイ1台（打刻用）+ PC・スマートフォン（閲覧用）
- 運用環境：学校施設内ネットワーク + インターネット接続

## 2. 機能要件

### 2.1 打刻機能

#### 2.1.1 基本打刻処理
- **機能概要**：NFC/RFIDカードのタッチによる出退勤記録
- **入力**：カードIDのHIDキーボード入力
- **処理**：
  1. カードIDを受信（連続入力+Enter または 0.5秒タイムアウト）
  2. カードIDでユーザー検索
  3. 前回勤務ステータスの逆を適用（初回は全員退勤状態のため出勤扱い）
  4. タイムスタンプ付きでデータベースに記録
- **出力**：WebUI画面での打刻完了表示

#### 2.1.2 エラーハンドリング
- **未登録カード**：「未登録カード」メッセージを表示
- **通信エラー**：通信エラーとは別画面で表示
- **重複打刻**：短時間連続タッチでも通常処理を実行

#### 2.1.3 自動退勤機能
- **実行時刻**：毎日23時
- **処理内容**：全員を強制退勤状態に変更
- **実行条件**：設定された時間帯のみ動作
- **ログ出力**：実行履歴をデータベースに保存

### 2.2 認証機能

#### 2.2.1 Discord OAuth認証
- **認証方式**：Discord OAuth + Supabase Auth連携
- **アクセス制限**：特定Discordサーバーメンバーのみ
- **ロール確認**：期生ロールの付与確認
- **エラー処理**：非メンバーのアクセス時はエラー画面表示

#### 2.2.2 権限管理
- **一般ユーザー**：自分の勤怠データ閲覧のみ
- **管理者**：全ユーザーデータ閲覧 + ユーザー管理機能
- **権限設定**：管理者がユーザー管理画面から設定

### 2.3 勤怠閲覧機能

#### 2.3.1 個人勤怠表示
- **表示内容**：個人の出退勤履歴（カレンダー形式）
- **操作方式**：キーボード操作を基本とし、マウス使用を最小限に抑制

#### 2.3.2 管理者用集計表示
- **表示内容**：日別の班・学年別人数集計
- **操作方法**：カレンダー日付クリックで該当日データを表示

### 2.4 ユーザー管理機能

#### 2.4.1 ユーザー情報管理
- **管理項目**：
  - DiscordユーザーID
  - ユーザー設定ID
  - カードID
  - 表示名（Discord名を参照：学籍番号）
  - ニックネーム
  - 期生
  - 班
- **操作機能**：強制出退勤、ユーザー情報編集
- **変更履歴**：全ての編集操作を履歴として保存

#### 2.4.2 データ移行機能
- **移行元**：Firebase
- **移行内容**：既存ユーザー情報、勤怠履歴
- **移行先**：Supabase PostgreSQL

## 3. 非機能要件

### 3.1 性能要件
- **応答時間**：打刻処理3秒以内、画面表示2秒以内
- **同時利用者数**：制限なし（Vercel・Supabase無料プラン範囲内）

### 3.2 可用性要件
- **稼働時間**：24時間365日（ラズベリーパイ常時稼働）
- **利用時間**：部活動時間帯（実際の打刻は活動時のみ）

### 3.3 セキュリティ要件
- **個人情報保護**：Supabaseには個人情報を保存せず、DiscordユーザーIDまたはユーザー設定IDのみ保存
- **アクセス制御**：Discord OAuth + 期生ロール確認
- **データ暗号化**：HTTPS通信、Supabase標準暗号化

### 3.4 運用性要件
- **データ保持**：勤怠データは永続保存
- **ログ管理**：
  - 全員退勤API実行ログ
  - ユーザー情報変更履歴
- **バックアップ**：Supabase自動バックアップ機能を利用

## 4. 制約条件

### 4.1 技術制約
- **使用技術**：Next.js, Supabase, Vercel, Discord OAuth
- **無料プラン制限**：
  - Supabase：500MB DB容量、50,000 MAU
  - Vercel：100GB転送量、非商用利用

### 4.2 運用制約
- **予算制約**：月額費用0円での運用
- **ネットワーク制約**：オンプレサーバー設置不可

### 4.3 ハードウェア制約
- **打刻端末**：ラズベリーパイ1台のみ
- **カードリーダー**：HIDキーボード入力対応NFC/RFIDリーダー

## 5. インターフェース要件

### 5.1 外部システム連携
- **Discord API**：OAuth認証、ユーザー情報取得、ロール確認
- **Supabase API**：データベース操作、リアルタイム更新

### 5.2 ユーザーインターフェース
- **打刻画面**：WebUI（ラズベリーパイ上のブラウザ表示）
- **管理画面**：レスポンシブWebアプリ（PC・スマートフォン対応）
- **操作方式**：キーボード操作優先設計
